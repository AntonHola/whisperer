<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Whisperer</title>

	<!-- Bootstrap -->
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

	<style type="text/css">
		#mainForm {
			text-align: center;
		}

		#keyName {
			text-align: right;
		}

		#list {
			width: 100%;
		}

		.time {
			font-size: 14px;
			white-space: nowrap;
		}

		.ms {
			font-size: 12px;
			color: gray;
		}

		.message {
			word-wrap: break-word;
			word-break: break-all;
			font-family: monospace;
			font-size: 14px;

		}

		.group {
			font-size: 12px;
			white-space: nowrap;
		}

		.thread {
			font-size: 12px;
			white-space: nowrap;
		}

		.filter {
			padding: 10px;
			vertical-align: top;
		}

		.filter A {

		}

		.filter UL {
			background-color: #dfe8ee;
			padding: 10px;
			list-style: none;
			min-width: 120px;
			border-radius: 5px;
		}

		.filter .header {
			font-weight: bold;
			text-align: center;
		}

		.filter UL LI {

		}

		.filter A.active {
			font-weight: bold;
			color: #4875a5;
		}

		.filterContainer {

		}

		.entry .metaInfo .glyphicon {
			display: inline-block;
			margin-right: 5px;
			margin-left: 5px;
			color: #888;
		}

		.level-DEBUG {
			background-color: #eeefff;
		}

		.level-TRACE {

			background-color: #e1ffe0;
		}

		.level-WARNING {
			background-color: #ffdfab;
		}

		.level-ERROR {
			background-color: #ffb3ae;
		}

		#mainForm #trackButton, #mainForm.active #stopButton {
			display: inline;
		}

		#mainForm #stopButton, #mainForm.active #trackButton {
			display: none;
		}
	</style>
</head>
<body>
<div class="container-fluid">
	<div class="row">
		<div class="col-lg-12">
			<h1>Whisperer</h1>

			<form id="mainForm" class="form-inline form-group-lg">
				<div class="form-group">
					<label class="sr-only" for="keyName">Email address</label>
					<input type="text" size="10" class="form-control" id="keyName" placeholder="Key">
				</div>
				<div class="form-group">=</div>
				<div class="form-group">
					<input type="text" size="40" class="form-control" id="expectedValue" placeholder="Expected value">
				</div>
				<button id="trackButton" class="btn btn-success btn-lg">
					<span class="glyphicon glyphicon-transfer" aria-hidden="true"></span>
					Listen
				</button>
				<button id="stopButton" class="btn btn-success btn-lg">
					<span class="glyphicon glyphicon-ban-circle" aria-hidden="true"></span>
					Stop
				</button>
			</form>
		</div>
	</div>
	<div class="row">
		<div class="col-lg-12 filterContainer">
			<table>
				<tr>
					<td class="filter">
						<h4>Group</h4>
						<ul id="groupFilter"></ul>
					</td>
					<td class="filter">
						<h4>Host</h4>
						<ul id="hostFilter"></ul>
					</td>
					<td class="filter">
						<h4>Thread</h4>
						<ul id="threadFilter"></ul>
					</td>
				</tr>
			</table>
		</div>
	</div>
	<div class="row">
		<div class="col-lg-12">
			<table id="list" class="table">
				<thead>
				<tr>
					<th></th>
					<th>Message</th>
				</tr>
				</thead>

				<tbody>
				</tbody>
			</table>
		</div>
	</div>
</div>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="http://underscorejs.org/underscore.js"></script>

<script id="rowTemplate" type="text/template">
	<%
	date = new Date(timestamp);
	%>
	<tr class='entry level-<%=level%>'>
		<td class="metaInfo">
			<div class="time">
				<span class="glyphicon glyphicon-time" aria-hidden="true"></span>
				<%= date.toTimeString().substring(0, 8)%><span class="ms">.<%=date.getMilliseconds()%></span> @
				<strong>
					<%
					var aHostName = abbriviateHostName(host)
					if (aHostName) {
					%>
					<abbr title='<%=host%>'><%=aHostName%></abbr>
					<% } else { %>
					<%=host%>
					<% } %>
				</strong>
			</div>
			<div class="group">
				<span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>
				<%
				var aGroup = abbriviateGroup(group)
				if (aGroup) {
				%>
				<abbr title='<%=group%>'><%=aGroup%></abbr>
				<% } else { %>
				<%=group%>
				<% } %>
			</div>
			<div class="thread">
				<span class="glyphicon glyphicon-tasks" aria-hidden="true"></span>
				<%=thread%>
			</div>
		</td>
		<td class="message"><%=htmlEncode(message)%></td>
	</tr>
</script>

<script id="filterTemplate" type="text/template">
	<li><a data-value="<%=value%>" href="#"><%=title%></a></li>
</script>

<script type="application/javascript">
	function abbriviateHostName(hostName) {
		var pattern = /[a-z0-9-_]+(\.[a-z0-9-_]+)+/i;
		return pattern.test(hostName)
			? /^[^.]+/.exec(hostName)
			: null;
	}

	function htmlEncode(value) {
		//create a in-memory div, set it's inner text(which jQuery automatically encodes)
		//then grab the encoded contents back out.  The div never exists on the page.
		return $('<div/>').text(value).html();
	}

	function abbriviateGroup(group) {
		var abbr = group.replace(/([a-z])[a-z0-9-_]+\./ig, "$1.");
		return abbr != group ? abbr : null;
	}

	var ListController = function ($container) {
		var self = this;

		self.$container = $container;

		self.template = _.template($("#rowTemplate").html());
		self.groupFilter = "";
		self.threadFilter = "";
		self.hostFilter = "";
		self.items = [];

		self.isMatching = function (i) {
			if (self.groupFilter && self.groupFilter != i.group)
				return false;
			if (self.threadFilter && self.threadFilter != i.thread)
				return false;
			if (self.hostFilter && self.hostFilter != i.host)
				return false;

			return true;
		};

		self.add = function (item) {
			if (self.isMatching(item))
				self.$container.append(self.template(item));
			self.items.push(item);
			if (self.registerNewItem)
				self.registerNewItem(item)
		};

		self.refresh = function () {
			self.$container.html("");

			_.chain(self.items)
				.filter(self.isMatching)
				.map(self.template)
				.each(function (i) {
					self.$container.append(i)
				});
		};
	};

	var FilterController = function ($container, onChange, positionSelector) {
		var self = this;
		self.$container = $container;
		self.itemSelector = positionSelector;
		self.positions = [];
		self.onChange = onChange;
		self.template = _.template($("#filterTemplate").html());

		self.registerNewItem = function (item) {
			var position = positionSelector(item);
			if (!_.contains(self.positions, position)) {
				self.positions.push(position);
				self.refresh()
			}
		};

		self.refresh = function () {
			self.$container.html(self.template({title: "All", value: ""}));

			_.each(self.positions, function (i) {
				self.$container.append(self.template({title: i, value: i}));
			});

			self.$container.find("a").click(function (e) {
				var value = $(e.target).attr('data-value');
				self.$container.find("a").removeClass("active");
				$(e.target).addClass("active");
				self.onChange(value);
				return false;
			})
		}
	};

	$(function () {
		var listController = new ListController($("#list").find("tbody"));

		var groupFilter = new FilterController($("#groupFilter"), function (newGroup) {
			listController.groupFilter = newGroup;
			listController.refresh()
		}, function (i) {
			return i.group;
		});

		var threadFilter = new FilterController($("#threadFilter"), function (newThread) {
			listController.threadFilter = newThread;
			listController.refresh()
		}, function (i) {
			return i.thread;
		});

		var hostFilter = new FilterController($("#hostFilter"), function (newHost) {
			listController.hostFilter = newHost;
			listController.refresh()
		}, function (i) {
			return i.host;
		});


		listController.registerNewItem = function (i) {
			groupFilter.registerNewItem(i);
			threadFilter.registerNewItem(i);
			hostFilter.registerNewItem(i);
		};

		function testDataProvider(sink) {
			$.ajax({
				url: "/test.json",
				dataType: "text"
			}).done(function (r) {
				_.chain(_.first(r.split("\n"), 100))
					.map(JSON.parse)
					.each(sink);
			});
		}

		//testDataProvider(listController.add);

		var eventSource;

		$("#stopButton").click(function () {
			$("#mainForm").removeClass("active");

			$("#keyName").prop('disabled', false);
			$("#expectedValue").prop('disabled', false);

			eventSource.close();
			return false;
		});

		$("#trackButton").click(function () {
			$("#mainForm").addClass("active");
			var keyName = $("#keyName").val();
			var expectedValue = $("#expectedValue").val();

			$("#keyName").prop('disabled', true);
			$("#expectedValue").prop('disabled', true);

			eventSource = new EventSource("/stream?k=" + encodeURIComponent(keyName) +
				"&v=" + encodeURIComponent(expectedValue));
			eventSource.addEventListener("log", function (e) {
				listController.add(JSON.parse(e.data));
			});
			return false;
		});
	});
</script>
</body>
</html>